<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scoping Review</title>
    <style>
        body {
            font-family: monospace;
            margin: 20px;
            background-color: #fff;
        }

        h1 {
            font-size: 1.5rem;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"], input[type="number"] {
            font-family: monospace;
            font-size: 1rem;
            padding: 8px;
        }

        button {
            padding: 10px 20px;
            font-family: monospace;
            font-size: 1rem;
            cursor: pointer;
        }

        pre, textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            background-color: black;
            color: lime;
            resize: vertical;
            margin-top: 10px;
        }

        table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
        }

        #spinner svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .log-info {
            color: #00ccff;
        }

        .log-warning {
            color: #ffb347;
        }

        .log-error {
            color: #ff6961;
        }

        .log-debug {
            color: #bbb;
        }
    </style>
</head>
<body>
    <h1>🔬 <strong>Scoping Review</strong></h1>

    <div class="input-row">
        <input id="query" type="text" placeholder="Enter your query..." style="flex: 1;" />
        <input id="startYear" type="number" min="1900" placeholder="Start Year" style="width: 120px;" />
        <input id="maxResults" type="number" min="10" max="10000" value="10" placeholder="Max Results" style="width: 120px;" />
        <button onclick="search()">Search</button>
        <div id="spinner" style="display: none;">
            <svg width="24" height="24" viewBox="0 0 100 100">
                <circle cx="50" cy="50" fill="none" stroke="#007bff" stroke-width="10" r="35"
                        stroke-dasharray="165 57">
                    <animateTransform attributeName="transform" type="rotate"
                                      repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1" />
                </circle>
            </svg>
        </div>
        <div id="searchStatus" style="font-size: 20px;">&nbsp;</div>
    </div>

    <div>
        <input type="text" id="logFilter" placeholder="🔎 Filter logs..." oninput="filterLogs()" padding: 8px; margin-bottom: 8px; font-family: monospace;" />
        <label><input type="checkbox" id="filterInfo" checked onchange="filterLogs()"> ℹ️ Info</label>
        <label><input type="checkbox" id="filterWarning" checked onchange="filterLogs()"> ⚠️ Warning</label>
        <label><input type="checkbox" id="filterError" checked onchange="filterLogs()"> ❌ Error</label>
        <pre id="logViewer" style="height: 300px; overflow-y: auto; background-color: #111; color: #ccc; font-family: monospace; font-size: 0.85rem; border-radius: 6px;"></pre>
    </div>

    <h2>📁 Search History</h2>
    <table id="historyTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Query</th>
                <th>Start Year</th>
                <th>Date</th>
                <th>Download</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let isSearching = false;
        let allParsedLogs = [];

        document.getElementById("query").addEventListener("keypress", e => { if (e.key === "Enter") search(); });
        document.getElementById("startYear").addEventListener("keypress", e => { if (e.key === "Enter") search(); });

        async function search() {
            if (isSearching) return;

            const query = document.getElementById("query").value.trim();
            const startYear = parseInt(document.getElementById("startYear").value.trim());
            const maxResults = parseInt(document.getElementById("maxResults").value.trim());

            if (!query || isNaN(startYear)) {
                alert("Please enter both a query and a valid start year.");
                return;
            }

            if (isNaN(maxResults) || maxResults < 10 || maxResults > 10000) {
                alert("Please enter a number between 10 and 10000 for max results.");
                return;
            }

            isSearching = true;
            document.getElementById("spinner").style.display = "block";
            document.querySelector("button[onclick='search()']").disabled = true;
            document.getElementById("searchStatus").textContent = "";
            document.getElementById("searchStatus").style.color = "gray";

            try {
                const res = await fetch(`/search?query=${encodeURIComponent(query)}&startYear=${startYear}&maxResults=${maxResults}`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                await loadLog();
                document.getElementById("searchStatus").textContent = "✅";
                document.getElementById("searchStatus").style.color = "green";

                loadHistory();
            } catch (err) {
                document.getElementById("logViewer").textContent = "❌ Error: " + err.message;
                document.getElementById("searchStatus").textContent = "❌";
                document.getElementById("searchStatus").style.color = "red";
            } finally {
                isSearching = false;
                document.getElementById("spinner").style.display = "none";
                document.querySelector("button[onclick='search()']").disabled = false;
            }
        }

        async function loadHistory() {
            const tableBody = document.querySelector("#historyTable tbody");
            tableBody.innerHTML = "";

            try {
                const res = await fetch("/search/history");
                const data = await res.json();

                (data?.$values || data).forEach(row => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.Id}</td>
                        <td>${row.QueryText}</td>
                        <td>${row.StartYear}</td>
                        <td>${new Date(row.SearchDate).toLocaleString()}</td>
                        <td>
                            <button onclick="download(${row.Id})">⬇️ Download</button>
                            <button onclick="view(${row.Id})">👁️ View</button>
                            <button onclick="deleteSearch(${row.Id})">🗑️ Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);

                });
            } catch (err) {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td colspan="5">❌ Failed to load history: ${err.message}</td>`;
                tableBody.appendChild(tr);
            }
        }

        async function download(searchId) {
            window.open(`/search/download/${searchId}`, '_blank');
        }

        function view(searchId) {
            window.location.href = `/results.html?searchId=${searchId}`;
        }

        async function loadLog() {
            const logViewer = document.getElementById("logViewer");
            logViewer.innerHTML = "Loading logs...";

            try {
                const res = await fetch("/search/lastlog");
                const rawLines = (await res.text()).trim().split("\n");

                allParsedLogs = rawLines.map(line => {
                    try {
                        const json = JSON.parse(line);
                        const time = json["@t"] || "";
                        const level = (json["@l"] || "info").toLowerCase();
                        const message = json["@m"] || "";
                        return { time, level, message };
                    } catch {
                        return { time: "", level: "debug", message: line };
                    }
                });

                filterLogs();
            } catch (err) {
                logViewer.textContent = "❌ Error loading logs: " + err.message;
            }
        }

        function filterLogs() {
            const search = document.getElementById("logFilter").value.toLowerCase();
            const showInfo = document.getElementById("filterInfo").checked;
            const showWarning = document.getElementById("filterWarning").checked;
            const showError = document.getElementById("filterError").checked;

            const filtered = allParsedLogs.filter(log =>
                log.message.toLowerCase().includes(search) &&
                (
                    (log.level === "info" && showInfo) ||
                    (log.level === "warning" && showWarning) ||
                    (log.level === "error" && showError) ||
                    (!["info", "warning", "error"].includes(log.level))
                )
            );

            renderLogs(filtered);
        }

        async function deleteSearch(searchId) {
            if (!confirm("Sei sicuro di voler eliminare questa ricerca e tutte le relative pubblicazioni?")) return;

            try {
                const res = await fetch(`/search/${searchId}`, {
                    method: "DELETE"
                });

                if (!res.ok) throw new Error(`Errore HTTP! Stato: ${res.status}`);

                alert("Ricerca eliminata con successo.");
                loadHistory();
            } catch (err) {
                alert("Errore durante l'eliminazione: " + err.message);
            }
        }

        function renderLogs(logs) {
            const logViewer = document.getElementById("logViewer");
            logViewer.innerHTML = "";

            logs.forEach(log => {
                const div = document.createElement("div");
                div.className = `log-${log.level}`;
                const icon = log.level === "warning" ? "⚠️" :
                    log.level === "error" ? "❌" :
                        log.level === "info" ? "ℹ️" : "🔹";
                div.textContent = `[${log.time}] ${icon} ${log.message}`;
                logViewer.appendChild(div);
            });
        }

        window.onload = () => {
            loadHistory();
            loadLog();
        };
    </script>
</body>
</html>
